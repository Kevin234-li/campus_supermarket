{% extends 'base.html' %}
{% block content %}
    <style>
        table{border-collapse: collapse;margin: 0 auto;}
        th{height: 40px;line-height: 40px;text-align: center}
        td{height: 40px;line-height: 40px;width: 120px;text-align: center}
        h1{font-size: 16px;margin-left: 190px}
        #end{width: 120px;height: 30px;padding:15px 0;background-color: #ff3d3d;font:30px bold 微软雅黑;float: right;
            color: #FFFFFF;text-align: center;margin-bottom: 20px}
        #total_pay, #num{font: 40px bold 微软雅黑;float: right;color: #ff1d2b;line-height: 61px;}
        .bottom{background-color: #fff4e8;height: 61px;line-height: 61px;margin: 10px auto;}
        .bottom_right{float: right;padding: 0px 7px;bottom: 10px;}
    </style>
    {% if num != 0 %}
        <h1>全部商品{{ num }}件</h1>
        <div style="margin: 10px auto;">
            <table border="1">
            <tr>
                <th></th>
                <th>商品名称</th>
                <th>商品价格</th>
                <th>单位</th>
                <th>数量</th>
                <th>小计</th>
                <th>操作</th>
            </tr>
            {% for goods in goods_list %}
                <tr>
                    <td><input type="checkbox" class="check_item" onclick="check(this)"/></td>
                    <td>{{ goods.goods_name }}</td>
                    <td>{{ goods.goods_price }}</td>
                    <td>{{ goods.goods_unit }}</td>
                    <td><button onclick="sub(this)">-</button><span>{{ goods.num }}</span><button onclick="add(this)">+</button></td>
                    <td class="money"></td>
                    <td><a href="{% url 'order:delete_cart' %}/?id={{ goods.item_id }}">删除</a></td>
                </tr>
            {% endfor %}
            </table>
            <div class="bottom">
                <span style="padding-left: 190px;"><input type="checkbox" id="checkAllBox" onclick="checkAllBox(this)"/>全选</span>
                <a id="end" href="{% url 'order:add_order' %}">去结算</a>
                <span class="bottom_right">合计：¥<label id="total_pay" style="padding-right: 20px"></label></span>
                <span class="bottom_right">件商品</span><label id="num"></label><span class="bottom_right">共计</span>
            </div>
        </div>
    {% else %}
        <div style="height:300px;margin: 0 auto">
            您的购物车是空的！
        </div>
    {% endif %}

    <script>
        window.onload=function () {
            var money = document.getElementsByClassName("money"),
                c = document.getElementById("checkAllBox");
            c.checked=true;
            for(i = 0;i<money.length;i++){
                var price = money[i].parentElement.children[2],
                    num = money[i].previousElementSibling.children[1];
                price = parseFloat(price.innerHTML);
                num = parseInt(num.innerHTML);
                money[i].innerHTML = price * num;
                money[i].parentElement.children[0].children[0].checked=true;
            }
            total_pay();
            var num = document.getElementById("num")
            num.innerHTML = money.length;
        }
        function sub(that) {
            var text = that.nextElementSibling;
            num = parseInt(text.innerHTML);
            if(num>1){
                text.innerHTML = num-1;
            }
            sum(that);
            total_pay();
        }
        function add(that) {
            var text = that.previousElementSibling;
            num = parseInt(text.innerHTML);
            text.innerHTML = num+1;
            sum(that);
            total_pay();
        }
        function sum(that) {
            var money = that.parentElement.nextElementSibling;
            var price = that.parentElement.previousElementSibling.previousElementSibling.innerHTML;
            var num = that.parentElement.children[1];
            price = parseFloat(price);
            num = parseInt(num.innerHTML);
            money.innerHTML = parseFloat(num * price);
        }
        function checkAllBox(that) {
            var checkboxs = document.getElementsByClassName("check_item"),
                num = document.getElementById("num");
            if(that.checked){
                for(i = 0;i<checkboxs.length;i++){
                    checkboxs[i].checked = true;
                }
                num.innerHTML = checkboxs.length;
            }
            else{
                for(i = 0;i<checkboxs.length;i++){
                    checkboxs[i].checked = false;
                }
                num.innerHTML = 0;
            }
            total_pay();
        }
        function check(that) {
            var checkboxs = document.getElementsByClassName("check_item");
            var c = document.getElementById("checkAllBox"),
                num = document.getElementById("num");
            if(that.checked)
                num.innerHTML = parseInt(num.innerHTML) + 1;
            else
                num.innerHTML = parseInt(num.innerHTML) - 1;
            for (i = 0;i<checkboxs.length;i++){
                if(!checkboxs[i].checked){
                    c.checked=false;
                    total_pay();
                    return;
                }
            }
            c.checked=true;
            total_pay();
        }
        function total_pay() {
            var money = document.getElementsByClassName("money"),
                total_pay = document.getElementById("total_pay");
            var sum = 0;
            for(i = 0;i<money.length;i++){
                if(money[i].parentElement.firstElementChild.firstElementChild.checked){
                    sum += parseFloat(money[i].innerHTML);
                }
            }
            total_pay.innerHTML = sum;
        }
    </script>
{% endblock %}